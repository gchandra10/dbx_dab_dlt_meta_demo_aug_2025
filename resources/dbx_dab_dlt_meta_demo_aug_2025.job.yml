# The main job for dlt-meta demo
# yaml-language-server: $schema=../bundle_config_schema.json

resources:
  jobs:
    dlt_meta_job:
      name: dlt_meta_job
      description: "Job to onboard DLT META data"

      tasks:
        - task_key: onboard_dlt_meta_task
          existing_cluster_id: "0805-034038-yqknazdr"
          spark_python_task:
            python_file: ${workspace.file_path}/src/onboard_metadata.py
            parameters:
              - --catalog_database
              - ${var.catalog_name}.${var.schema_name}
              - --onboarding_file_path
              - ${var.people_onboarding_file_path}
              - --bronze_dataflowspec_table
              - ${var.bronze_dataflowspecTable}
              - --silver_dataflowspec_table
              - ${var.silver_dataflowspecTable}
              - --env
              - ${bundle.target}
              - --import_author
              - ${var.author}
              - --overwrite
              - "True"
              - --version
              - ${var.version}
              - --onboard_layer
              - "bronze_silver"
              - --uc_enabled
              - ${var.uc_enabled}

        - task_key: onboard_fanout_dlt_meta_task
          existing_cluster_id: "0805-034038-yqknazdr"
          spark_python_task:
            python_file: ${workspace.file_path}/src/onboard_fanout_metadata.py
            parameters:
              - --catalog_database
              - ${var.catalog_name}.${var.schema_name}
              - --onboarding_file_path
              - ${var.people_fanout_onboarding_file_path}
              - --silver_dataflowspec_table
              - ${var.silver_dataflowspecTable}
              - --env
              - ${bundle.target}
              - --import_author
              - ${var.author}
              - --overwrite
              - "False"
              - --version
              - ${var.version}
              - --onboard_layer
              - "silver"
              - --uc_enabled
              - ${var.uc_enabled}
          depends_on:
            - task_key: onboard_dlt_meta_task

        # This is alternative way using dlt_meta wheel package
        
        # - task_key: onboard_fanout_dlt_meta_task
        #   existing_cluster_id: "0805-034038-yqknazdr"
        #   python_wheel_task:
        #     package_name: dlt_meta
        #     entry_point: run
        #     named_parameters:
        #       database: ${var.catalog_name}.${var.schema_name}
        #       onboarding_file_path: ${var.people_fanout_onboarding_file_path}
        #       silver_dataflowspec_table: ${var.silver_dataflowspecTable}
        #       uc_enabled: "True"
        #       import_author: Ganesh
        #       version: v1
        #       onboard_layer: silver
        #       overwrite: "False"
        #       env: dev
        #   depends_on:
        #     - task_key: onboard_dlt_meta_task

    dlt_pipelines_job:
      name: dlt_pipelines_job
      description: "Job to deploy the Bronze and Silver DLT-META pipelines"

      tasks:
        - task_key: dlt_meta_bronze_people_task
          description: "Run DLT pipeline for Bronze People"
          pipeline_task:
            pipeline_id: ${resources.pipelines.pipeline_dlt_meta_bronze_people.id}
            full_refresh: true

        - task_key: dlt_meta_silver_people_task
          description: "Run DLT pipeline for Silver People"
          pipeline_task:
            pipeline_id: ${resources.pipelines.pipeline_dlt_meta_silver_people.id}
            full_refresh: true
          depends_on:
            - task_key: dlt_meta_bronze_people_task